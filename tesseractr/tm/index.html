<!DOCTYPE HTML>
<html>
  <head>
    <script src="/dist/tesseract.min.js"></script>
    <style>
      body {
        height: 100vh;
        margin: 10px;
      }

      #imageGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(205px, 1fr));
        gap: 20px;
        justify-content: center;
        align-items: center;
      }

      .thumbnail {
        width: 205px;
        height: 150px;
        border: 3px solid black;
        overflow: hidden;
        position: relative;
      }

      .thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    v10.2
    <input type="file" id="uploader" multiple>
    <div id="imageGrid"></div>

<script type="module">
  const scheduler = Tesseract.createScheduler();

  const workerGen = async () => {
    const worker = await Tesseract.createWorker("hin", 1, {
      corePath: '../../node_modules/tesseract.js-core',
      workerPath: "/dist/worker.min.js",
      logger: function(m){console.log(m);}
    });
    scheduler.addWorker(worker);
    return worker;
  }

  const workerN = 10;
  const workers = [];

  (async () => {
    for (let i=0; i<workerN; i++) {
      workers.push(await workerGen());
    }
  })();

  const recognize = async function(evt) {
    const files = evt.target.files;
    const imageGrid = document.getElementById('imageGrid');
    imageGrid.innerHTML = '';

    const allData = []; // Array to store word bboxes, confidence, and image names

    const processFile = async (file, index) => {
      return new Promise((resolve) => {
        const reader = new FileReader();

        reader.onload = async function(e) {
          const thumbnailContainer = document.createElement('div');
          thumbnailContainer.classList.add('thumbnail');

          const thumbnailImage = document.createElement('img');
          thumbnailImage.src = e.target.result;

          thumbnailContainer.appendChild(thumbnailImage);
          imageGrid.appendChild(thumbnailContainer);

          console.log(`Processing file: ${file.name}`);

          const worker = workers[index % workers.length]; // Correct worker assignment

          const { data } = await worker.recognize(file);

          const imageInfo = {
            imageName: file.name,
            words: data.words.map(word => ({
              text: word.text,
              bbox: word.bbox,
              confidence: word.confidence // Include confidence value
            }))
          };

          console.log(`File ${file.name} processed. Word count: ${data.words.length}`);

          allData.push(imageInfo); // Collect image info for each file

          resolve();
        };

        reader.readAsDataURL(file);
      });
    };

    const promises = [];

    for (let i = 0; i < files.length; i++) {
      promises.push(processFile(files[i], i));
    }

    await Promise.all(promises); // Wait for all files to be processed

    // Rest of your code (writing to JSON file, etc.)
  };

  const elm = document.getElementById('uploader');
  elm.addEventListener('change', recognize);

  // Function to trigger download of JSON file with real-time progress logging
  function download(content, filename, contentType, progressCallback) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;

    // Use XMLHttpRequest to monitor real-time progress
    const xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'blob';

    xhr.onprogress = function (e) {
      if (progressCallback) {
        progressCallback(e);
      }
    };

    xhr.onload = function () {
      const downloadedBlob = new Blob([xhr.response], { type: contentType });
      const downloadedUrl = URL.createObjectURL(downloadedBlob);

      a.href = downloadedUrl;
      a.click();

      console.log('Download initiated. Please check your browser downloads.');

      URL.revokeObjectURL(downloadedUrl);
      URL.revokeObjectURL(url);
    };

    xhr.send();
  }
</script>

  </body>
</html>
